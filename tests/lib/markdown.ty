import markdown (..)

fn first-child-of-type(node, tp) {
    for child in node.children {
        if child.type == tp {
            return child
        }
    }
}

fn children-of-type(node, tp) {
    let result = []
    for child in node.children {
        if child.type == tp {
            result.push(child)
        }
    }
    result
}

fn child-count(node) {
    let n = 0
    for _ in node.children { n += 1 }
    n
}

@test
fn test-parse-returns-document() {
    let doc: _ = parse('hello')
    assert(doc != nil, 'parse should return a node')
    assert(doc.type == NodeType.Document)
}

@test
fn test-plain-text() {
    let doc: _ = parse('hello world')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('hello world'), "expected 'hello world' in: {html}")
}

@test
fn test-heading-levels() {
    for level in 1..7 {
        let prefix = '#' * level
        let doc: _ = parse("{prefix} Heading {level}")
        assert(doc != nil)
        let html = doc.html
        assert(html.contains?("<h{level}>"), "expected <h{level}> in: {html}")
        assert(html.contains?("Heading {level}"), "expected 'Heading {level}' in: {html}")
        assert(html.contains?("</h{level}>"), "expected </h{level}> in: {html}")
    }
}

@test
fn test-heading-node-properties() {
    let doc: _ = parse('## My Heading')
    assert(doc != nil)
    let heading = first-child-of-type(doc, NodeType.Heading)
    assert(heading != nil, 'should find a heading node')
    assert(heading.heading-level == 2, "expected level 2, got {heading.heading-level}")
}

@test
fn test-emphasis() {
    let doc: _ = parse('this is *emphatic*')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<em>emphatic</em>'), "expected <em> in: {html}")
}

@test
fn test-strong() {
    let doc: _ = parse('this is **bold**')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<strong>bold</strong>'), "expected <strong> in: {html}")
}

@test
fn test-inline-code() {
    let doc: _ = parse('use `foo()` here')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<code>foo()</code>'), "expected <code> in: {html}")
}

@test
fn test-code-block() {
    let md = '```
print("hello")
```'
    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<pre>'), "expected <pre> in: {html}")
    assert(html.contains?('print("hello")'), "expected code content in: {html}")
}

@test
fn test-code-block-with-language() {
    let md = '```python
def foo():
    pass
```'
    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('language-python'), "expected language-python in: {html}")
}

@test
fn test-code-block-info-string() {
    let md = '```rust
fn main() {}
```'
    let doc: _ = parse(md)
    assert(doc != nil)
    let block = first-child-of-type(doc, NodeType.CodeBlock)
    assert(block != nil, 'should have a code block')
    assert(block.info-string == 'rust', "expected 'rust', got: {block.info-string}")
}

@test
fn test-link() {
    let doc: _ = parse('[click here](https://example.com)')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<a href="https://example.com">'), "expected link href in: {html}")
    assert(html.contains?('click here'), "expected link text in: {html}")
}

@test
fn test-link-node-properties() {
    let doc: _ = parse('[text](https://example.com)')
    assert(doc != nil)
    let para: _ = first-child-of-type(doc, NodeType.Paragraph)
    assert(para != nil)
    let link: _ = first-child-of-type(para, NodeType.Link)
    assert(link != nil, 'should find a link node')
    assert(link.url == 'https://example.com', "expected url, got: {link.url}")
}

@test
fn test-image() {
    let doc: _ = parse('![alt text](image.png)')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<img src="image.png">'), "expected img tag in: {html}")
}

@test
fn test-unordered-list() {
    let md = '- one
- two
- three'
    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<ul>'), "expected <ul> in: {html}")
    assert(html.contains?('<li>'), "expected <li> in: {html}")
    assert(html.contains?('one'), "expected 'one' in: {html}")
    assert(html.contains?('two'), "expected 'two' in: {html}")
    assert(html.contains?('three'), "expected 'three' in: {html}")
}

@test
fn test-ordered-list() {
    let md = '1. first
2. second
3. third'
    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<ol>'), "expected <ol> in: {html}")
    assert(html.contains?('<li>'), "expected <li> in: {html}")
    assert(html.contains?('first'), "expected 'first' in: {html}")
}

@test
fn test-list-type-bullet() {
    let md = '- a
- b'
    let doc: _ = parse(md)
    assert(doc != nil)
    let list = first-child-of-type(doc, NodeType.List)
    assert(list != nil, 'should find a list node')
    assert(list.list-type == ListType.Bullet, "expected bullet list")
}

@test
fn test-list-type-ordered() {
    let md = '1. a
2. b'
    let doc: _ = parse(md)
    assert(doc != nil)
    let list = first-child-of-type(doc, NodeType.List)
    assert(list != nil, 'should find a list node')
    assert(list.list-type == ListType.Ordered, "expected ordered list")
}

@test
fn test-paragraph() {
    let doc: _ = parse('A simple paragraph.')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<p>A simple paragraph.</p>'), "expected paragraph in: {html}")
}

@test
fn test-multiple-paragraphs() {
    let md = 'First paragraph.

Second paragraph.'
    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('First paragraph'), "expected first paragraph in: {html}")
    assert(html.contains?('Second paragraph'), "expected second paragraph in: {html}")
    let paras = children-of-type(doc, NodeType.Paragraph)
    assert(paras.len() == 2, "expected 2 paragraphs, got {paras.len()}")
}

@test
fn test-children-iteration() {
    let md = '# Title

Some text.

- item'
    let doc: _ = parse(md)
    assert(doc != nil)
    let n = child-count(doc)
    assert(n >= 3, "expected at least 3 children, got {n}")

    let types = []
    for child in doc.children {
        types.push(child.type)
    }
    assert(types[0] == NodeType.Heading)
    assert(types[1] == NodeType.Paragraph)
    assert(types[2] == NodeType.List)
}

@test
fn test-nested-formatting() {
    let doc: _ = parse('this is ***bold and italic***')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<strong>'), "expected <strong> in: {html}")
    assert(html.contains?('<em>'), "expected <em> in: {html}")
}

@test
fn test-empty-input() {
    let doc: _ = parse('')
    assert(doc != nil, 'empty input should still return a document node')
    assert(doc.type == NodeType.Document)
    let n = child-count(doc)
    assert(n == 0, "expected 0 children for empty input, got {n}")
}

@test
fn test-complex-document() {
    let md = '# My Document

This is a paragraph with **bold**, *italic*, and `code`.

## Section 1

- item one
- item two
- item three

### Code Example

```ty
let x = 42
print(x)
```

Check out [this link](https://example.com) for more.

1. First
2. Second
3. Third'

    let doc: _ = parse(md)
    assert(doc != nil)
    let html = doc.html

    assert(html.contains?('<h1>'), "expected h1")
    assert(html.contains?('My Document'), "expected 'My Document'")
    assert(html.contains?('<strong>bold</strong>'), "expected bold")
    assert(html.contains?('<em>italic</em>'), "expected italic")
    assert(html.contains?('<code>code</code>'), "expected inline code")
    assert(html.contains?('<h2>'), "expected h2")
    assert(html.contains?('<ul>'), "expected unordered list")
    assert(html.contains?('<h3>'), "expected h3")
    assert(html.contains?('language-ty'), "expected language-ty")
    assert(html.contains?('let x = 42'), "expected code content")
    assert(html.contains?('<a href="https://example.com">'), "expected link")
    assert(html.contains?('<ol>'), "expected ordered list")
}

@test
fn test-text-node-type() {
    let doc: _ = parse('hello')
    assert(doc != nil)
    let para: _ = first-child-of-type(doc, NodeType.Paragraph)
    assert(para != nil)
    let txt: _ = first-child-of-type(para, NodeType.Text)
    assert(txt != nil, 'should find a text node')
    assert(txt.text == 'hello', "expected 'hello', got: {txt.text}")
}

@test
fn test-document-html-wrapper() {
    let doc: _ = parse('hi')
    assert(doc != nil)
    let html = doc.html
    assert(html.contains?('<html>'), "expected <html> wrapper")
    assert(html.contains?('<body>'), "expected <body> wrapper")
    assert(html.contains?('</body>'), "expected </body>")
    assert(html.contains?('</html>'), "expected </html>")
}
